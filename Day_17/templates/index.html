<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VoIP Chat & Call</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body, html { height: 100%; margin: 0; }
    .sidebar { background: #f8f9fa; }
    .chat-area, .sidebar { overflow-y: auto; }
    .msg-bubble { border-radius: 1rem; margin: .25rem; padding: .5rem .75rem; max-width: 75%; }
    .msg-sent .msg-bubble { background: #0d6efd; color: white; margin-left: auto; }
    .msg-recv .msg-bubble { background: #fff; }
    .active-contact { background: #d1e7dd; }
    .badge-unread { position: absolute; top: 0.5rem; right: 1rem; }
    @media (max-width: 767px) {
      .sidebar { height: 30vh; }
    }
  </style>
</head>
<body class="d-flex flex-column vh-100">

  <!-- Header -->
  <nav class="navbar bg-primary text-white p-2">
    <h5 class="mb-0">Logged in as <strong>{{ username }}</strong></h5>
  </nav>

  <!-- Main Content -->
  <div class="d-flex flex-grow-1">
    <div class="sidebar col-md-3 p-2 border-end">
      <h6>Contacts</h6>
      <ul id="contactsList" class="list-group">
        {% for c in contacts %}
          {% if c != username %}
            <li id="contact-{{ c }}" class="list-group-item position-relative">
              {{ c }}
              <span id="badge-{{ c }}" class="badge bg-danger rounded-pill badge-unread"></span>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>

    <div class="chat-area col flex-grow-1 d-flex flex-column p-2">
      <!-- Call control -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div><strong id="currentChatLabel">Select a contact</strong></div>
        <div>
          <button id="callBtn" class="btn btn-success btn-sm" disabled>Call</button>
          <button id="endBtn" class="btn btn-danger btn-sm d-none">End</button>
        </div>
      </div>

      <!-- Chat messages scroll -->
      <div id="messages" class="flex-grow-1 p-2 bg-light rounded"></div>

      <!-- Input area -->
      <div class="input-group mt-2">
        <input id="chatInput" class="form-control" placeholder="Type a message..." disabled>
        <button id="sendBtn" class="btn btn-primary" disabled>Send</button>
      </div>
    </div>
  </div>

  <!-- Modal: Incoming call -->
  <div class="modal fade" id="callModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3 text-center">
        <h5>Incoming call from <span id="modalCaller"></span></h5>
        <button id="acceptBtn" class="btn btn-success me-2">Accept</button>
        <button id="rejectBtn" class="btn btn-danger">Reject</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script>
    const socket = io();
    let currentUser = "{{ username }}";
    const contacts = JSON.parse('{{ contacts|tojson|safe }}');
    let currentTarget = null;
    let chatHistory = {}, unread = {}, peer, localStream;

    // Initialize chatHistory and unread
    contacts.forEach(c => { if(c!==currentUser){ chatHistory[c]=[]; unread[c]=0; } });

    const cl = document.getElementById('contactsList');
    contacts.forEach(c => {
      if (c !== currentUser) {
        let li = document.getElementById('contact-' + c);
        li.onclick = () => selectContact(c);
      }
    });

    function selectContact(c) {
      currentTarget = c;
      document.getElementById('currentChatLabel').textContent = 'Chat with ' + c;
      document.getElementById('chatInput').removeAttribute('disabled');
      document.getElementById('sendBtn').removeAttribute('disabled');
      document.getElementById('callBtn').removeAttribute('disabled');
      contacts.forEach(d => {
        if (d!==currentUser) document.getElementById('contact-'+d).classList.remove('active-contact');
      });
      document.getElementById('contact-' + c).classList.add('active-contact');
      unread[c] = 0;
      document.getElementById('badge-'+c).textContent = '';
      loadChatHistory(c);
    }

    socket.on('online_users', onUsers);
    function onUsers(users){
      contacts.forEach(c => {
        if(c!==currentUser){
          let li = document.getElementById('contact-'+c);
          li.querySelector('.online-dot')?.remove();
          let dot = document.createElement('span');
          dot.textContent = ' ●';
          dot.className = users.includes(c)? 'text-success online-dot' : 'text-secondary';
          li.appendChild(dot);
        }
      });
    }

    navigator.mediaDevices.getUserMedia({audio:true}).then(s=>localStream=s);

    function setupPeer(to) {
      peer = new RTCPeerConnection();
      if(localStream) localStream.getTracks().forEach(t=>peer.addTrack(t, localStream));
      peer.ontrack = e=> new Audio(URL.createObjectURL(new Blob(e.streams))).play();
      peer.onicecandidate = e=> e.candidate && socket.emit('signal',{target:to, candidate:e.candidate});
    }

    document.getElementById('callBtn').onclick = ()=>{
      if(!currentTarget) return;
      setupPeer(currentTarget);
      peer.createOffer().then(o=>{
        peer.setLocalDescription(o);
        socket.emit('call', {from: currentUser, target:currentTarget, offer:o});
      });
    };

    socket.on('incoming_call', d => {
      document.getElementById('modalCaller').textContent = d.from;
      currentTarget = d.from;
      setupPeer(d.from);
      peer.setRemoteDescription(new RTCSessionDescription(d.offer));
      new bootstrap.Modal(document.getElementById('callModal')).show();
    });

    document.getElementById('acceptBtn').onclick = ()=>{
      new bootstrap.Modal(document.getElementById('callModal')).hide();
      peer.createAnswer().then(a=>{
        peer.setLocalDescription(a);
        socket.emit('signal',{target:currentTarget,answer:a});
      });
      toggleCallUI(true);
    };

    document.getElementById('rejectBtn').onclick = ()=>{
      socket.emit('reject_call',{from:currentUser,target:currentTarget});
      new bootstrap.Modal(document.getElementById('callModal')).hide();
    };

    document.getElementById('endBtn').onclick = ()=>{
      socket.emit('end_call',{from:currentUser,target:currentTarget});
      endCallUI();
    };

    socket.on('signal', d=>{
      d.candidate && peer.addIceCandidate(new RTCIceCandidate(d.candidate));
      d.answer && peer.setRemoteDescription(new RTCSessionDescription(d.answer)) && toggleCallUI(true);
    });

    socket.on('call_rejected', d=>alert(`${d.from} rejected your call`));
    socket.on('call_ended', d=>{ alert(`${d.from} ended call`); endCallUI(); });

    // Chat handling
    document.getElementById('sendBtn').onclick = ()=>{
      const text = document.getElementById('chatInput').value.trim();
      if(!text || !currentTarget) return;
      socket.emit('message',{from:currentUser,target:currentTarget,text});
      saveAndAppend(currentUser, text);
      document.getElementById('chatInput').value='';
    };

    socket.on('message', d =>{
      saveAndAppend(d.from, d.text);
      if(d.from===currentTarget) {
        appendMessage(d.from, d.text, 'recv');
      } else {
        unread[d.from]++;  
        document.getElementById('badge-'+d.from).textContent = unread[d.from];
      }
    });

    function saveAndAppend(sender, text){
      chatHistory[sender].push({sender, text});
    }

    function appendMessage(sender, text, type){
      const cont = document.getElementById('messages');
      let div = document.createElement('div');
      div.className = `d-flex ${type==='sent'?'justify-content-end':'justify-content-start'}`;
      let b = document.createElement('span');
      b.className = 'msg-bubble';
      b.textContent=text;
      div.appendChild(b);
      cont.appendChild(div);
      cont.scrollTop = cont.scrollHeight;
    }

    function loadChatHistory(c){
      fetch(`/history/${c}`)
        .then(res=>res.json())
        .then(msgs=>{
          document.getElementById('messages').innerHTML='';
          msgs.forEach(m=> appendMessage(m.sender, m.text, m.sender===currentUser?'sent':'recv'));
        });
    }

    function toggleCallUI(inCall){
      document.getElementById('callBtn').classList.toggle('d-none', inCall);
      document.getElementById('endBtn').classList.toggle('d-none', !inCall);
      document.getElementById('currentChatLabel').textContent = inCall? `In call with ${currentTarget}` : `Chat with ${currentTarget}`;
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
